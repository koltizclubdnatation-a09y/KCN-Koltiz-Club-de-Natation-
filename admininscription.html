<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>KCN ‚Äî Admin Inscriptions & Paiements</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"/>
  <!-- Librairie PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --brand:#0066cc; --accent:#00bcd4; --sun:#ff9800;
      --ink:#0f172a; --muted:#475569; --line:#e5e7eb; --page:#f7f9fc; --card:#ffffff;
      --danger:#ef4444; --success:#10b981; --warn:#f59e0b;
      --radius:16px; --shadow:0 18px 48px rgba(2,6,23,.12);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Montserrat',sans-serif;background:var(--page);color:var(--ink);line-height:1.6}
    a{color:var(--brand);text-decoration:none}
    .wrap{max-width:1200px;margin:28px auto 60px;padding:0 16px}
    header .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    header h1{font-size:1.6rem;color:#0b4573}
    .bar{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 16px}
    .bar input[type="search"], .bar select{
      padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;min-width:180px
    }
    .btn{background:linear-gradient(90deg,var(--brand),#2499ff);color:#fff;border:0;border-radius:12px;
      padding:10px 14px;font-weight:800;cursor:pointer;box-shadow:0 10px 26px rgba(0,102,204,.20)}
    .btn.ghost{background:#fff;color:var(--brand);border:2px solid var(--brand);box-shadow:none}
    .btn.warn{background:linear-gradient(90deg,var(--sun),#ffc107)}
    .btn.danger{background:linear-gradient(90deg,var(--danger),#ff6b6b)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:20px;box-shadow:var(--shadow)}
    .panel .hd{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
    .panel .hd h2{font-size:1.1rem;color:#0b4573}
    .panel .bd{padding:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 10px;border-bottom:1px solid var(--line);text-align:left}
    th{font-size:.9rem;color:#0b4573}
    tbody tr:hover{background:#f8fbff}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:800;font-size:.8rem}
    .paid{background:rgba(16,185,129,.12);color:#065f46;border:1px solid rgba(16,185,129,.35)}
    .pending{background:rgba(245,158,11,.12);color:#7c2d12;border:1px solid rgba(245,158,11,.35)}
    .await{background:rgba(15,23,42,.06);color:#0f172a;border:1px solid rgba(15,23,42,.15)}
    .chip{border:1px solid rgba(0,102,204,.25);background:rgba(0,102,204,.06);color:#0b4573;border-radius:999px;padding:6px 10px;font-weight:700}
    .mini{font-size:.9rem;color:#475569}
    .act{display:flex;gap:6px;flex-wrap:wrap}
    .money{white-space:nowrap}
    .foot{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    /* Drawer */
    .drawer{position:fixed;inset:0;display:none}
    .drawer.show{display:block}
    .mask{position:absolute;inset:0;background:rgba(2,6,23,.55);backdrop-filter:blur(2px)}
    .sheet{position:absolute;right:0;top:0;height:100%;width:min(560px,92vw);background:#fff;border-left:1px solid var(--line);box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden}
    .sheet .head{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .sheet .body{padding:16px;overflow:auto;position:relative} /* position:relative to allow paid stamp overlay */
    .kv{display:grid;grid-template-columns:140px 1fr;gap:10px;margin:8px 0}
    .proof{margin-top:10px;border:1px dashed var(--line);border-radius:12px;padding:10px}
    .proof img{max-width:100%;border-radius:10px;display:block}
    .proof .file{display:inline-block;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#f8fafc}
    .empty{padding:24px;text-align:center;color:#64748b}
    /* Gate */
    .gate{max-width:520px;margin:8vh auto 0;padding:18px;background:#fff;border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow)}
    .gate h3{color:#0b4573;margin-bottom:8px}
    .gate input{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px}
    .gate .row{display:flex;gap:10px;margin-top:10px}

    /* Paid stamp style (used in drawer overlay and fallback HTML) */
    .paid-stamp {
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%) rotate(-22deg);
      font-size:72px;
      font-weight:900;
      letter-spacing:2px;
      color: rgba(16,185,129,0.14);
      text-transform:uppercase;
      border:8px solid rgba(16,185,129,0.12);
      padding:8px 16px;
      pointer-events:none;
      z-index:20;
      white-space:nowrap;
    }
  </style>
</head>
<body>
  <div class="wrap" id="app" style="display:none">
    <header>
      <div class="top">
        <h1>üõ°Ô∏è KCN ‚Äî Administration des inscriptions & paiements</h1>
        <div class="act">
          <a class="btn ghost" href="./inscription1eretapes.html">‚Üê Retour Formulaire</a>
          <button class="btn" id="exportCsv">Exporter CSV</button>
        </div>
      </div>

      <div class="panel">
        <div class="hd"><h2>Filtres & recherche</h2><span class="chip">Cl√© stockage : <strong>kcn_receipts</strong></span></div>
        <div class="bd">
          <div class="bar">
            <input id="q" type="search" placeholder="Recherche (nom, email, re√ßu, r√©f)‚Ä¶"/>
            <select id="fStatus">
              <option value="">Tous statuts</option>
              <option value="PAY√â">PAY√â</option>
              <option value="EN ATTENTE">EN ATTENTE</option>
              <option value="EN ATTENTE ‚Äî PREUVE √Ä VALIDER">EN ATTENTE ‚Äî PREUVE √Ä VALIDER</option>
              <option value="EN ATTENTE ‚Äî V√âRIF VIREMENT">EN ATTENTE ‚Äî V√âRIF VIREMENT</option>
            </select>
            <select id="fMethod">
              <option value="">Toutes m√©thodes</option>
              <option value="cash">Esp√®ces / Cash</option>
              <option value="bank">Virement</option>
              <option value="moncash">MonCash</option>
              <option value="natcash">NatCash</option>
            </select>
            <select id="sort">
              <option value="date_desc">Tri : Date ‚Üì</option>
              <option value="date_asc">Tri : Date ‚Üë</option>
              <option value="name_asc">Tri : Nom A‚ÜíZ</option>
              <option value="name_desc">Tri : Nom Z‚ÜíA</option>
              <option value="tot_desc">Tri : Total ‚Üì</option>
              <option value="tot_asc">Tri : Total ‚Üë</option>
            </select>
            <button class="btn warn" id="markPaidSel">Marquer PAY√â (s√©lection)</button>
            <button class="btn danger" id="deleteSel">Supprimer (s√©lection)</button>
          </div>
        </div>
      </div>
    </header>

    <section class="panel" style="margin-top:16px">
      <div class="hd"><h2>Re√ßus enregistr√©s</h2></div>
      <div class="bd">
        <div id="tableWrap"></div>
        <div class="foot mini">
          <div><span id="count"></span></div>
          <div>Astuce : clique sur le N¬∞ de re√ßu pour ouvrir le d√©tail</div>
        </div>
      </div>
    </section>
  </div>

  <!-- === Gate d'acc√®s admin === -->
  <div id="gate" class="wrap">
    <div class="gate">
      <h3>Acc√®s administration KCN</h3>
      <p class="mini">Entrez le code d‚Äôadministration.</p>
      <div class="row">
        <input id="gateInput" type="password" placeholder="Code admin"/>
        <button id="gateBtn" class="btn">Entrer</button>
      </div>
      <p class="mini" style="margin-top:8px">Conseil : modifiez le code dans la constante <strong>ADMIN_PASS</strong> du script.</p>
    </div>
  </div>

  <!-- === Drawer d√©tail === -->
  <div class="drawer" id="drawer">
    <div class="mask" id="drawerMask"></div>
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="head">
        <strong id="dNo">Re√ßu</strong>
        <div class="act">
          <button class="btn" id="dPrint">T√©l√©charger/Imprimer</button>
          <!-- Bouton PDF + partage -->
          <button type="button" class="btn" id="dPdf">T√©l√©charger PDF + Partager</button>
          <button class="btn warn" id="dPaid">Marquer PAY√â</button>
          <button class="btn ghost" id="dClose">Fermer</button>
        </div>
      </div>
      <div class="body" id="dBody"></div>
    </div>
  </div>

<script>
const STORAGE_KEY = 'kcn_receipts';
const ADMIN_PASS  = 'KCN-ADMIN';

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

// Outils formatting
function fmt(n) {
  return new Intl.NumberFormat('fr-FR', {maximumFractionDigits: 2}).format(n)
    .replace(/\u202F|\u00A0/g, ' ');
}
function fmtMoney(v, cur) {
  return (cur === 'USD' ? '$ ' : '') + fmt(v) + (cur === 'HTG' ? ' HTG' : '');
}
function csvEscape(s) {
  if (s==null) return '';
  s = String(s).replace(/"/g, '""');
  return (/[",;\n]/.test(s) ? `"${s}"` : s);
}
function safeParse(x, f = []) {
  try { return JSON.parse(x || '[]'); } catch { return f; }
}

// √âtat
let DATA = [];
let SELECTED = new Set();
let CUR = null;

// Chargement depuis le localstorage
function loadList() { return safeParse(localStorage.getItem(STORAGE_KEY), []); }
function saveList(list) { localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

// Affichage et interactions
function render() {
  const q = $('#q')?.value.trim().toLowerCase() ?? '';
  const fStatus = $('#fStatus')?.value ?? '';
  const fMethod = $('#fMethod')?.value ?? '';
  const sort = $('#sort')?.value ?? '';

  let list = [...DATA];

  // Filtres statut / m√©thode
  list = list.filter(x => {
    const okS = !fStatus || (x.status||'').toUpperCase() === fStatus.toUpperCase();
    const okM = !fMethod || (x.method||'') === fMethod;
    return okS && okM;
  });

  // Recherche
  if(q){
    list = list.filter(x=>{
      const hay = [
        x.no, x.name, x.email, x.method, x.currency,
        (x.proof?.ref||''), (x.proof?.phone||''),
        (x.rows||[]).map(r=>r.label).join(' ')
      ].join(' ').toLowerCase();
      return hay.includes(q);
    });
  }

  // Tri
  list.sort((a,b)=>{
    const aId = Number(a.id)||0, bId = Number(b.id)||0;
    switch(sort){
      case 'date_asc':  return aId-bId;
      case 'name_asc':  return (a.name||'').localeCompare(b.name||'');
      case 'name_desc': return (b.name||'').localeCompare(a.name||'');
      case 'tot_asc':   return (a.tot||0)-(b.tot||0);
      case 'tot_desc':  return (b.tot||0)-(a.tot||0);
      default:
      case 'date_desc': return bId-aId;
    }
  });

  // Affichage table
  const tableHtml = list.length ? `
    <table aria-label="Liste des re√ßus">
      <thead>
        <tr>
          <th><input type="checkbox" id="chkAll"></th>
          <th>Re√ßu</th>
          <th>Date</th>
          <th>Nom</th>
          <th>M√©thode</th>
          <th>Devise</th>
          <th style="text-align:right">Total (affich√©)</th>
          <th>Mois</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        ${list.map(x=>{
          const rate = Number(x.rate||0);
          const cur = x.currency||'HTG';
          const totDisp = cur==='USD' && rate>0 ? x.tot/rate : x.tot;
          const month = guessMonth(x.rows);
          const checked = SELECTED.has(String(x.id)) ? 'checked' : '';
          return `
          <tr data-id="${x.id}">
            <td><input type="checkbox" class="chk" ${checked}></td>
            <td><a href="#" class="open" title="Voir le re√ßu">${x.no||'‚Äî'}</a></td>
            <td>${x.date||'‚Äî'}</td>
            <td>${x.name||'‚Äî'}<div class="mini">${x.email||''}</div></td>
            <td>${(x.method||'-').toUpperCase()}</td>
            <td>${cur}</td>
            <td class="money" style="text-align:right">${fmtMoney(totDisp, cur)}</td>
            <td>${month}</td>
            <td>${statusBadge(x.status)}</td>
            <td class="act">
              <button class="btn warn sm open">Ouvrir</button>
              <button class="btn sm setPaid">PAY√â</button>
              <button class="btn ghost sm setWait">EN ATTENTE</button>
              <button class="btn danger sm del">Supprimer</button>
            </td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>
  ` : `<div class="empty">Aucun re√ßu trouv√©.</div>`;
  $('#tableWrap').innerHTML = tableHtml;
  $('#count').textContent = `${list.length} re√ßu(x) affich√©(s) ‚Ä¢ ${DATA.length} au total`;

  // S√©lection globale
  $('#chkAll')?.addEventListener('change', (e)=>{
    $$('tbody .chk').forEach(ch=>{
      ch.checked = e.target.checked;
      const id = ch.closest('tr').dataset.id;
      if(e.target.checked) SELECTED.add(id); else SELECTED.delete(id);
    });
  });

  // S√©lection individuelle
  $$('tbody .chk').forEach(ch=>{
    ch.addEventListener('change', (e)=>{
      const id = e.target.closest('tr').dataset.id;
      if(e.target.checked) SELECTED.add(id); else SELECTED.delete(id);
    });
  });

  // Ouverture Drawer/d√©tail
  $$('tbody .open').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.preventDefault();
      openDrawer(btn.closest('tr').dataset.id);
    });
  });

  // Actions sur ligne
  $$('tbody .setPaid').forEach(btn=>{
    btn.addEventListener('click', ()=>setStatus(btn.closest('tr').dataset.id,'PAY√â'));
  });
  $$('tbody .setWait').forEach(btn=>{
    btn.addEventListener('click', ()=>setStatus(btn.closest('tr').dataset.id,'EN ATTENTE'));
  });
  $$('tbody .del').forEach(btn=>{
    btn.addEventListener('click', ()=>delOne(btn.closest('tr').dataset.id));
  });
}
// Helper pour le mois
function guessMonth(rows){
  const r = (rows||[]).find(x=>/Mois:\s*/i.test(x.label||''));
  if(!r) return '‚Äî';
  const m = r.label.match(/Mois:\s*([A-Za-z√Ä-√ø]+)/i);
  return m ? m[1] : '‚Äî';
}
// Helper filigrane/statut
function statusBadge(s){
  const cls = (s||'').toUpperCase()==='PAY√â' ? 'paid'
            : (s||'').includes('PREUVE') || (s||'').includes('V√âRIF') ? 'pending' : 'await';
  return `<span class="badge ${cls}">${s||'‚Äî'}</span>`;
}

// Drawer/d√©tail
function openDrawer(id){
  CUR = DATA.find(x => String(x.id) === String(id));
  if (!CUR) return;
  $('#dNo').textContent = CUR.no || 'Re√ßu';
  const cur = CUR.currency || 'HTG', rate = Number(CUR.rate || 0);

  const rowsHTML = (CUR.rows||[]).map(r=>{
    const vHTG = Number(r.amt||0), v = cur==='USD' ? (rate>0 ? vHTG/rate : vHTG) : vHTG;
    return `<tr><td>${r.label}</td><td>${r.qty||1}</td><td class="money" style="text-align:right">${fmtMoney(v, cur)}</td></tr>`;
  }).join('');
  const subDisp = cur==='USD' && rate>0 ? CUR.sub/rate : CUR.sub;
  const feeDisp = cur==='USD' && rate>0 ? CUR.fee/rate : CUR.fee;
  const totDisp = cur==='USD' && rate>0 ? CUR.tot/rate : CUR.tot;

  let proofBox = '';
  if(!CUR.proof) {
    proofBox = '<div class="mini">Aucune preuve fournie.</div>';
  } else {
    const p = CUR.proof;
    let media = '';
    if(p.fileData) {
      if(p.fileData.startsWith('data:application/pdf')) {
        media = `<a class="file" href="${p.fileData}" target="_blank" rel="noopener">üìÑ Ouvrir la preuve (PDF)</a>`;
      } else {
        media = `<img src="${p.fileData}" alt="Preuve de paiement">`;
      }
    } else if(p.fileName){
      media = `<div class="file">Fichier: ${p.fileName}</div>`;
    }
    proofBox = `<div class="proof">
      <div><strong>R√©f:</strong> ${p.ref||'‚Äî'}</div>
      <div><strong>N¬∞ / Compte:</strong> ${p.phone||'‚Äî'}</div>
      <div><strong>Date/heure:</strong> ${p.when||'‚Äî'}</div>
      <div style="margin-top:8px">${media}</div>
    </div>`;
  }

  // Build the body HTML. If the status is 'PAY√â', inject the big green stamp overlay into the drawer body.
  const isPaid = (CUR.status||'').toString().trim().toUpperCase() === 'PAY√â';

  $('#dBody').innerHTML = `
    ${isPaid ? '<div class="paid-stamp">PAY√â</div>' : ''}
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
      ${statusBadge(CUR.status)}
      <span class="chip">${(CUR.method||'-').toUpperCase()} ‚Ä¢ ${cur}</span>
    </div>
    <div class="kv"><div><strong>N¬∞ de re√ßu</strong></div><div>${CUR.no||'‚Äî'}</div></div>
    <div class="kv"><div><strong>Date</strong></div><div>${CUR.date||'‚Äî'}</div></div>
    <div class="kv"><div><strong>Nom</strong></div><div>${CUR.name||'‚Äî'}</div></div>
    <div class="kv"><div><strong>Email</strong></div><div>${CUR.email||'‚Äî'}</div></div>
    <h3 style="margin:10px 0;color:#0b4573">D√©tail</h3>
    <table>
      <thead><tr><th>Description</th><th>Qt√©</th><th style="text-align:right">Montant</th></tr></thead>
      <tbody>${rowsHTML}</tbody>
    </table>
    <div style="display:flex;justify-content:flex-end;margin-top:10px">
      <table>
        <tr><td>Sous-total</td><td style="text-align:right" class="money">${fmtMoney(subDisp, cur)}</td></tr>
        <tr><td>Frais paiement</td><td style="text-align:right" class="money">${fmtMoney(feeDisp, cur)}</td></tr>
        <tr><th>Total</th><th style="text-align:right" class="money">${fmtMoney(totDisp, cur)}</th></tr>
      </table>
    </div>
    <h3 style="margin:14px 0;color:#0b4573">Preuve</h3>
    ${proofBox}
    <p class="mini" style="margin-top:10px">
      Filigrane : automatique selon statut et preuve.
    </p>`;
  $('#drawer').classList.add('show');
}
function closeDrawer(){ $('#drawer').classList.remove('show'); CUR=null; }
$('#dClose').addEventListener('click', closeDrawer);
$('#drawerMask').addEventListener('click', closeDrawer);

// Statut
function setStatus(id, status, silent){
  const i = DATA.findIndex(x => String(x.id) === String(id));
  if (i < 0) return;
  DATA[i].status = status;
  saveList(DATA);
  if (!silent) alert('Statut mis √† jour.');
  render();
}

// Suppression
function delOne(id) {
  if (!confirm('Supprimer ce re√ßu ?')) return;
  DATA = DATA.filter(x => String(x.id) !== String(id));
  saveList(DATA);
  SELECTED.delete(String(id));
  render();
}

// Boutons s√©lection multiple
function markPaidSelected() {
  if (SELECTED.size === 0) return alert('S√©lection vide.');
  DATA = DATA.map(x => SELECTED.has(String(x.id)) ? {...x, status:'PAY√â'} : x);
  saveList(DATA); render(); alert('S√©lection marqu√©e PAY√â.');
}
function deleteSelected(){
  if (SELECTED.size === 0) return alert('S√©lection vide.');
  if (!confirm('Supprimer tous les re√ßus s√©lectionn√©s ?')) return;
  DATA = DATA.filter(x => !SELECTED.has(String(x.id)));
  saveList(DATA); SELECTED.clear(); render();
}

// Export CSV (suppose que la fonction download existe d√©j√† dans ton projet)
function download(filename, content){
  const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}
function exportCSV() {
  const head = [
    'id','no','date','name','email','method','currency','rate',
    'sub_HTG','fee_HTG','tot_HTG','status','proof_ref','proof_phone','proof_when','proof_file'
  ];
  const rows = DATA.map(x=>[
    x.id, x.no, x.date, x.name, x.email, x.method, x.currency, x.rate,
    x.sub, x.fee, x.tot, x.status,
    x.proof?.ref||'', x.proof?.phone||'', x.proof?.when||'', x.proof?.file||x.proof?.fileName||''
  ]);
  const csv = [head.map(csvEscape).join(','), ...rows.map(r=>r.map(csvEscape).join(','))].join('\n');
  download('kcn_receipts.csv', csv);
}

// Impression navigateur (avec texte √©cologique) + big PAY√â stamp when status is PAY√â
function printReceipt(d) {
  const s = (d.status||'').toString().toUpperCase();
  // Determine watermark: show PAY√â in green when status is PAY√â, otherwise show the pending stamp
  let wm = '';
  if (s === 'PAY√â') {
    wm = 'PAY√â';
  } else {
    const proofOk = d.proof && d.proof.ref && d.proof.phone && d.proof.when && (d.proof.fileData || d.proof.fileName);
    if(['MONCASH','NATCASH','BANK'].includes((d.method||'').toUpperCase()) && !proofOk) wm = 'EN ATTENTE ‚Äî PREUVE √Ä VALIDER';
    else if((d.method||'').toLowerCase()==='bank' && proofOk) wm = 'EN ATTENTE ‚Äî V√âRIF VIREMENT';
    else wm = 'EN ATTENTE';
  }

  const cur = d.currency||'HTG', rate = Number(d.rate||0);
  const subDisp = cur==='USD' && rate>0 ? d.sub/rate : d.sub;
  const feeDisp = cur==='USD' && rate>0 ? d.fee/rate : d.fee;
  const totDisp = cur==='USD' && rate>0 ? d.tot/rate : d.tot;

  const win = window.open('', 'PRINT', 'height=900,width=900');
  win.document.write(`<!doctype html><html><head><title>${d.no||'Re√ßu KCN'}</title>
    <meta charset="utf-8">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      body{font-family:Montserrat,Arial,sans-serif;padding:24px;color:#0f172a}
      h2{margin:0 0 8px 0;color:#0b4573}
      .chip{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#f8fafc;font-weight:700;color:#0b4573}
      table{width:100%;border-collapse:collapse}
      th,td{border-bottom:1px solid #e5e7eb;padding:10px 8px;text-align:left}
      th{color:#0b4573}
      .wm{position:fixed; inset:0; display:${wm?'grid':'none'}; place-items:center; pointer-events:none; z-index:0;}
      .wm span{font-size:92px; font-weight:900; letter-spacing:4px; color:${s === 'PAY√â' ? 'rgba(16,185,129,0.14)' : 'rgba(15,23,42,0.09)'}; transform:rotate(-20deg); text-transform:uppercase;}
    </style>
    </head><body>`);
  win.document.write(`
    <div class="wm"><span>${wm}</span></div>
    <h2>Re√ßu KCN / KOLTIZ Club de Natation</h2>
    <div style="color:#2d5c8a;margin:4px 0 10px;font-size:.98em">
      Pour √©viter les d√©chets d'emballage excessifs, nous n'incluons pas de re√ßus papier. Cependant, vous pouvez toujours en imprimer un pour vos archives.
    </div>
    <div style="display:flex;gap:8px;align-items:center;margin:6px 0">
      ${statusBadge(d.status)}<span class="chip">${(d.method||'-').toUpperCase()} ‚Ä¢ ${cur}</span>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:12px;margin:8px 0">
      <div><strong>N¬∞:</strong> ${d.no||'‚Äî'}</div>
      <div><strong>Date:</strong> ${d.date||'‚Äî'}</div>
      <div><strong>Nom:</strong> ${d.name||'‚Äî'}</div>
      <div><strong>Email:</strong> ${d.email||'‚Äî'}</div>
    </div>
    <table><thead><tr><th>Description</th><th>Qt√©</th><th>Montant</th></tr></thead>
      <tbody>
      ${(d.rows||[]).map(r=>{
        const vHTG = Number(r.amt||0), v = cur==='USD' ? (rate>0 ? vHTG/rate : vHTG) : vHTG;
        return `<tr><td>${r.label}</td><td>${r.qty||1}</td><td style="text-align:right">${fmtMoney(v, cur)}</td></tr>`;
      }).join('')}
      </tbody>
    </table>
    <div style="display:flex;justify-content:flex-end;margin-top:10px">
      <table>
        <tr><td>Sous-total</td><td style="text-align:right">${fmtMoney(subDisp, cur)}</td></tr>
        <tr><td>Frais paiement</td><td style="text-align:right">${fmtMoney(feeDisp, cur)}</td></tr>
        <tr><th>Total</th><th style="text-align:right">${fmtMoney(totDisp, cur)}</th></tr>
      </table>
    </div>
    <p style="margin-top:12px">
      <em>Merci pour votre confiance !</em><br>
      <strong>Therese Redgie Marc</strong> ‚Äî Secr√©taire administrative - KCN
    </p>
    </body></html>`);
  win.document.close(); 
  win.focus();
  if (!/Mobi|Android/i.test(navigator.userAgent)) setTimeout(()=>win.close(), 1500);
}

// Boutons drawer
$('#dPaid').addEventListener('click', ()=>{
  if(!CUR) return;
  setStatus(CUR.id,'PAY√â', true);
  openDrawer(CUR.id);
});
$('#dPrint').addEventListener('click', ()=>{
  if(!CUR) return;
  printReceipt(CUR);
});

// Bouton PDF + partage (WhatsApp / Email)
// Added big PAY√â stamp in generated PDF and fallback HTML when status is PAY√â
document.getElementById('dPdf').addEventListener('click', async function() {
  const status = document.querySelector('#dBody .badge')?.textContent || '-';
  const no = document.getElementById('dNo')?.textContent || '-';
  const name = document.querySelector('#dBody .kv:nth-child(4) div:last-child')?.textContent || '-';
  const email = document.querySelector('#dBody .kv:nth-child(5) div:last-child')?.textContent || '-';
  const date = document.querySelector('#dBody .kv:nth-child(3) div:last-child')?.textContent || '-';
  const methodChip = document.querySelector('#dBody .chip')?.textContent || '-';

  // Items factur√©s:
  let itemsText = '';
  document.querySelectorAll('#dBody tbody tr').forEach(tr => {
    const tds = tr.querySelectorAll('td');
    itemsText += `${tds[0]?.textContent} x${tds[1]?.textContent}: ${tds[2]?.textContent}\n`;
  });

  // --- LOGO --- (attempt, but optional)
  const logoUrl = "./folder3/imaj10"; // √† adapter!
  async function loadLogo(){
    return new Promise((resolve) => {
      const img = new window.Image();
      img.crossOrigin = "Anonymous";
      img.src = logoUrl;
      img.onload = function() {
        const cnv = document.createElement('canvas');
        cnv.width = img.width; cnv.height = img.height;
        cnv.getContext('2d').drawImage(img,0,0);
        resolve(cnv.toDataURL('image/png'));
      };
      img.onerror = function(){ resolve(null); };
    });
  }
  const logoData = await loadLogo();

  // --- PDF ---
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation: 'portrait', unit: 'mm', format: 'a4'});
  let y = 18;

  // Decor/logo
  if (logoData) doc.addImage(logoData, 'PNG', 18, y-10, 24, 24);
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(20);
  doc.text("Re√ßu KCN / KOLTIZ Club de Natation", 48, y);
  doc.setDrawColor(0,102,204);doc.setLineWidth(1);
  doc.line(18, y+3, 190, y+3); 
  y += 10;

  // Texte √©cologique dans le PDF
  doc.setFontSize(9);
  doc.setFont('helvetica','normal');
  doc.setTextColor(30,64,130);
  const ecoLines = doc.splitTextToSize(
    "Pour √©viter les d√©chets d'emballage excessifs, nous n'incluons pas de re√ßus papier. Cependant, vous pouvez toujours en imprimer un pour vos archives.",
    170
  );
  doc.text(ecoLines, 20, y);
  y += ecoLines.length * 4 + 6;

  // If paid, add big green stamp "PAY√â" on the PDF (centered, rotated)
  const isPaid = (status||'').toString().trim().toUpperCase() === 'PAY√â';
  if (isPaid) {
    // semi-transparent effect by drawing the text with low opacity if supported
    try {
      // try to set opacity via internal GState (may not be available in some builds)
      if (doc.setGState) {
        doc.setGState({opacity:0.12});
        doc.setFontSize(72);
        doc.setTextColor(16,185,129);
        // center-ish position
        doc.text("PAY√â", 105, 95, {angle:-22, align:'center'});
        doc.setGState({opacity:1});
      } else {
        // fallback: normal text with subtle color
        doc.setFontSize(48);
        doc.setTextColor(16,185,129);
        doc.text("PAY√â", 105, 80, {angle:-20, align:'center'});
      }
    } catch (e) {
      // fallback
      doc.setFontSize(48);
      doc.setTextColor(16,185,129);
      doc.text("PAY√â", 105, 80, {angle:-20, align:'center'});
    }
  }

  // Infos principales
  doc.setFontSize(12); 
  doc.setFont('helvetica','normal');
  doc.setTextColor(30,64,130);
  doc.text(`Statut: ${status}`, 20, y); y+=8;
  doc.text(`N¬∞ de re√ßu: ${no}`, 20, y); y+=8;
  doc.text(`Date: ${date}`, 20, y); y+=8;
  doc.text(`Nom: ${name}`, 20, y); y+=8;
  doc.text(`Email: ${email}`, 20, y); y+=8;
  doc.text(`Mode: ${methodChip}`, 20, y); y+=10;

  doc.setFont('helvetica','bold'); 
  doc.setFontSize(13); 
  doc.setTextColor(255,152,0); // orange
  doc.text("√âl√©ments factur√©s :", 20, y); 
  y += 7;
  doc.setFont('helvetica','normal'); 
  doc.setFontSize(11); 
  doc.setTextColor(20,30,50);

  itemsText.split('\n').forEach(line => { 
    if (line.trim()) { 
      doc.text(line, 20, y); 
      y+=6; 
    } 
  });

  y+=4;
  doc.setFontSize(12);
  doc.setFont('helvetica','bold'); 
  doc.setTextColor(31,64,130);
  // totRow extraction: attempt to find the Total text in the drawer; fallback to empty
  let totRow = '';
  const totEl = document.querySelector('#dBody th.money');
  if (totEl) totRow = totEl.textContent;
  if (!totRow) totRow = '‚Äî';
  doc.text(`Total: ${totRow}`, 20, y); 
  y+=10;

  doc.setFontSize(10);
  doc.setFont('helvetica','normal');
  doc.setTextColor(90,110,140);
  doc.text("Merci pour votre confiance !", 20, y); 
  y+=6;
  doc.text("Therese Redgie Marc ‚Äî Secr√©taire administrative ‚Ä¢ KCN", 20, y);

  // --- G√©n√®re PDF ---
  const fileName = `Recu_${no.replace(/\s+/g,'')}.pdf`;
  doc.save(fileName);

  // --- ENVOI WHATSAPP/EMAIL ---
  const pdfBlob = doc.output('blob');
  const pdfUrl = URL.createObjectURL(pdfBlob);

  // WhatsApp : message + lien
  const summary = encodeURIComponent(
    `Re√ßu KCN / KOLTIZ\nN¬∞: ${no}\nNom: ${name}\nTotal: ${totRow}\n\nT√©l√©charge le PDF : `
  );
  const wappUrl = "https://wa.me/?text=" + summary + encodeURIComponent(pdfUrl);

  // Email
  const subject = encodeURIComponent(`Re√ßu KCN pour ${name}`);
  const body =
    encodeURIComponent(`Bonjour,\n\nVous trouverez ci-joint votre re√ßu pour le paiement au KCN.\nTotal: ${totRow}\nLien: ${pdfUrl}\n\nMerci, l'√©quipe KCN`);
  const mailtoUrl = `mailto:${email}?subject=${subject}&body=${body}`;

  setTimeout(() => {
    if (confirm("Partager le re√ßu PDF par WhatsApp ? (Sinon validez pour Email)")) {
      window.open(wappUrl, "_blank");
    } else {
      window.open(mailtoUrl, "_blank");
    }
  }, 600);
});

// Init/reload
function init(){
  DATA = loadList();
  SELECTED = new Set();
  ['q','fStatus','fMethod','sort'].forEach(id=>$('#'+id).addEventListener('input', render));
  $('#markPaidSel').addEventListener('click', markPaidSelected);
  $('#deleteSel').addEventListener('click', deleteSelected);
  $('#exportCsv').addEventListener('click', exportCSV);
  render();
}

// Gate d'acc√®s
try{ sessionStorage.removeItem('kcn_admin_ok'); }catch(e){}
(function gate(){
  const passOK = sessionStorage.getItem('kcn_admin_ok')==='1';
  if(passOK){ $('#gate').style.display='none'; $('#app').style.display='block'; init(); return; }
  $('#gate').style.display='block'; $('#app').style.display='none';
  function tryEnter(){
    if($('#gateInput').value===ADMIN_PASS){
      sessionStorage.setItem('kcn_admin_ok','1');
      $('#gate').style.display='none'; $('#app').style.display='block'; init();
    } else alert('Code incorrect.');
  }
  $('#gateBtn').addEventListener('click', tryEnter);
  $('#gateInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') tryEnter(); });
})();
</script>

</body>
</html>
