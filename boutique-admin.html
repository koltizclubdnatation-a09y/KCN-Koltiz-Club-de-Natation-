<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KCN ‚Äî Admin (Commandes & Stock)</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--brand:#0066cc;--line:#e5e7eb;--ink:#0f172a;--card:#fff;--page:#f7f9fc}
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Montserrat,Arial,sans-serif;background:var(--page);color:var(--ink)}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  h1{color:var(--brand);margin-bottom:12px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
  .tabbtn{background:#fff;color:#0066cc;border:2px solid #0066cc;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  .tabbtn.active{background:#0066cc;color:#fff}
  .tools{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
  button,.btn{background:#0066cc;color:#fff;border:0;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  .btn.alt{background:#fff;color:#0066cc;border:2px solid #0066cc}
  .btn.ghost{background:#fff;color:#475569;border:2px dashed #cbd5e1}
  .list{display:grid;gap:12px;margin-top:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .lines{margin-top:8px;border-top:1px dashed var(--line);padding-top:8px}
  .tag{display:inline-block;background:#eaf3ff;color:#0b4573;border:1px solid #cfe1ff;border-radius:999px;padding:3px 8px;font-size:.85rem;margin-right:6px}
  .muted{color:#475569}
  .thumb{max-width:160px;max-height:120px;border-radius:8px;border:1px solid var(--line)}
  input,select,textarea{padding:8px 10px;border:1px solid var(--line);border-radius:10px;font-family:inherit}

  .panel{display:none}
  .panel.active{display:block}

  /* Badges stock */
  .kcn-tag{display:inline-block;border-radius:999px;padding:4px 8px;font-size:.78rem;border:1px solid #e5e7eb;background:#f8fafc}
  .kcn-tag.red{background:#ffe4e6;border-color:#fecdd3;color:#9f1239}
  .kcn-tag.orange{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
  .kcn-tag.green{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}

  /* Porte discr√®te */
  #gate{position:fixed;inset:0;display:grid;place-items:center;background:rgba(2,6,23,.85);z-index:9999}
  #gate .box{background:#fff;border:1px solid #e5e7eb;border-radius:14px;max-width:420px;width:min(92vw,420px);padding:18px;box-shadow:0 24px 60px rgba(0,0,0,.35)}
  #gate h2{margin:0 0 6px 0;color:#0b4573}
  #gate .mini{font-size:.9rem;color:#475569;margin-bottom:10px}
  #gate .row{gap:8px;justify-content:flex-end}
  #gate .hint{color:#64748b;font-size:.85rem;margin-top:8px}
  #gate .err{color:#b91c1c;font-weight:700;display:none}
  #mask{filter:blur(10px);pointer-events:none;user-select:none}

  /* Flottants */
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
</style>
</head>
<body>

<!-- === Porte discr√®te === -->
<div id="gate" aria-modal="true" role="dialog">
  <div class="box">
    <h2>Acc√®s administration</h2>
    <div class="mini">Zone r√©serv√©e. Entrez le code pour continuer.</div>
    <label for="gateCode" class="muted" style="display:block;margin-bottom:6px">Code</label>
    <input id="gateCode" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" style="width:100%;margin-bottom:10px">
    <div class="row">
      <button class="btn alt" id="gateCancel">Annuler</button>
      <button class="btn" id="gateOk">Entrer</button>
    </div>
    <div class="err" id="gateErr">Code incorrect.</div>
    <div class="hint">Astuce : <kbd>Shift</kbd>+<kbd>Alt</kbd>+<kbd>S</kbd> rouvre la porte.</div>
  </div>
</div>

<!-- === Contenu admin (flout√© tant que non d√©verrouill√©) === -->
<div id="mask">
  <div class="wrap">
    <div class="topbar">
      <h1>Admin KCN ‚Äî Commandes & Stock (localStorage)</h1>
      <div style="display:flex;gap:8px">
        <button class="btn ghost" id="btnLogout" title="Verrouiller l'admin">Verrouiller</button>
        <!-- lien retour boutique (garde le tien si le nom du fichier est diff√©rent) -->
        <a class="btn alt" href="./boutique-kcn.html">‚Üê Retour boutique</a>
      </div>
    </div>

    <!-- Onglets -->
    <div class="tabs">
      <button class="tabbtn active" data-tab="orders">Commandes</button>
      <button class="tabbtn" data-tab="stock">Stock</button>
    </div>

    <!-- ===== Panel Commandes ===== -->
    <section id="panel-orders" class="panel active" aria-labelledby="tab-orders">
      <div class="tools">
        <button id="refresh">Actualiser</button>
        <button id="export" class="btn alt">Exporter CSV</button>
        <button id="applySales" class="btn">Appliquer ventes ‚Üí stock</button>
        <button id="clear" class="btn alt">Vider toutes les commandes</button>
      </div>
      <div id="count" class="muted"></div>
      <div id="list" class="list"></div>
    </section>

    <!-- ===== Panel Stock ===== -->
    <section id="panel-stock" class="panel" aria-labelledby="tab-stock">
      <div class="tools">
        <button id="kcnStockShowAll" class="btn alt">Afficher / Actualiser</button>
        <button id="kcnStockSave" class="btn">Enregistrer</button>
        <button id="kcnStockExport" class="btn alt">Exporter JSON</button>
        <button id="kcnStockImportBtn" class="btn alt">Importer catalogue</button>
        <button id="kcnStockReset" class="btn alt">R√©initialiser</button>
      </div>

      <div class="muted" style="margin:6px 0 10px 0">
        <strong>L√©gende :</strong>
        <span class="kcn-tag green">En stock</span>
        <span class="kcn-tag orange">Stock limit√©</span>
        <span class="kcn-tag orange">Stock critique</span>
        <span class="kcn-tag red">Rupture</span>
      </div>

      <div class="muted" style="margin:6px 0 10px 0">
        Seuils :
        <label><b>Critique</b> ‚â§
          <input id="kcnThLow" type="number" min="1" value="5" style="width:60px">
        </label> ¬∑
        <label><b>Limit√©</b> ‚â§
          <input id="kcnThMid" type="number" min="2" value="10" style="width:60px">
        </label>
        <span class="muted">‚Äî 0 = Rupture</span>
      </div>

      <div style="overflow:auto;border:1px solid #e5e7eb;border-radius:12px;background:#fff">
        <table id="kcnStockTable" style="width:100%;border-collapse:collapse">
          <thead style="background:#f8fafc">
            <tr>
              <th style="text-align:left;padding:10px;border-bottom:1px solid #e5e7eb">ID produit</th>
              <th style="text-align:left;padding:10px;border-bottom:1px solid #e5e7eb">Nom</th>
              <th style="text-align:center;padding:10px;border-bottom:1px solid #e5e7eb;white-space:nowrap">Stock</th>
              <th style="text-align:center;padding:10px;border-bottom:1px solid #e5e7eb">Statut</th>
              <th style="text-align:center;padding:10px;border-bottom:1px solid #e5e7eb">Actions</th>
            </tr>
          </thead>
          <tbody id="kcnStockBody"></tbody>
        </table>
      </div>

      <!-- Dialog d'import -->
      <dialog id="kcnStockImportDialog">
        <h3 style="margin:0 0 10px 0;color:#0b4573">Importer un catalogue</h3>
        <p class="muted">Format JSON : <code>[{"id":"bonnet-p","name":"Bonnet (petit)","stock":12}, ...]</code></p>
        <textarea id="kcnStockImportText" rows="10" style="width:100%"></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
          <button id="kcnStockImportCancel" class="btn alt">Annuler</button>
          <button id="kcnStockImportApply" class="btn">Importer</button>
        </div>
      </dialog>
    </section>
  </div>
</div>

<script>
  /* ===================== NAV TABS ===================== */
  document.querySelectorAll('.tabbtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('panel-'+btn.dataset.tab).classList.add('active');
      if(btn.dataset.tab==='orders'){ loadOrders(false); }
      if(btn.dataset.tab==='stock'){ KCNStock.open(); }
    });
  });

  /* ===================== UTIL ===================== */
  function fmt(v,cur){ return (isNaN(v)?'‚Äî':new Intl.NumberFormat('fr-FR').format(v)+(cur==='HTG'?' HTG':'')); }
  function view(htg,currency){ return currency==='USD' ? NaN : htg; }
  function qtySafe(n){ return Math.max(0, parseInt(n||'0',10)||0); }

  /* ===================== PANEL COMMANDES ===================== */
  const list = document.getElementById('list');
  const count= document.getElementById('count');

  document.getElementById('refresh').onclick = ()=> loadOrders(false);
  document.getElementById('applySales').onclick = ()=> applyNewSalesToStock();
  document.getElementById('clear').onclick = ()=>{
    if(confirm('Supprimer TOUTES les commandes ?')){
      localStorage.removeItem('kcn_orders'); loadOrders(false);
    }
  };

  document.getElementById('export').onclick = ()=>{
    const orders = JSON.parse(localStorage.getItem('kcn_orders')||'[]');
    if(!orders.length){ alert('Rien √† exporter.'); return; }
    const rows = [['id','createdAt','currency','grandHTG','status','deliveryStatus','stockApplied','lines']];
    orders.forEach(o=>{
      rows.push([o.id,o.createdAt,o.currency,o.grandHTG,o.status||'',o.deliveryStatus||'', o.stockApplied? 'yes':'no', (o.lines||[]).map(l=>`${l.name}x${l.qty}`).join(' | ')]);
    });
    const csv = rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download='kcn_orders.csv'; a.click(); URL.revokeObjectURL(url);
  };

  // üîÅ ICI : quand on change Statut / Livraison / Paiement v√©rifi√©,
  // on enregistre ET on re-render pour avoir directement le "2e mod√®le"
  document.addEventListener('change', (e)=>{
    if(e.target.matches('select[data-id]')){
      const id  = e.target.getAttribute('data-id');
      const key = e.target.getAttribute('data-k');
      const val = e.target.value;
      const orders = JSON.parse(localStorage.getItem('kcn_orders')||'[]');
      const i = orders.findIndex(o=>o.id===id);
      if(i>=0){
        orders[i][key] = val;
        localStorage.setItem('kcn_orders', JSON.stringify(orders));
        // rechargement visuel ‚Üí badges + bouton Re√ßu mis √† jour
        loadOrders(false);
      }
    }
  });

  document.addEventListener('click', (e)=>{
    const t = e.target;

    // supprimer commande
    if(t.matches('button[data-del]')){
      const id = t.getAttribute('data-del');
      if(confirm('Supprimer cette commande ?')){
        const orders = JSON.parse(localStorage.getItem('kcn_orders')||'[]').filter(o=>o.id!==id);
        localStorage.setItem('kcn_orders', JSON.stringify(orders));
        loadOrders(false);
      }
      return;
    }

    // re√ßu (provisoire / d√©finitif)
    if(t.matches('button[data-receipt]')){
      const id = t.getAttribute('data-receipt');
      generateReceipt(id);
    }
  });

  function loadOrders(applySales=false){
    const orders = JSON.parse(localStorage.getItem('kcn_orders')||'[]');
    count.textContent = orders.length ? orders.length+' commande(s)' : 'Aucune commande';
    list.innerHTML = '';
    if(!orders.length){
      list.innerHTML = '<div class="card muted">Aucune commande pour le moment.</div>';
    } else {
      orders.slice().reverse().forEach(o=>{
        const card = document.createElement('div');
        card.className='card';
        const date = new Date(o.createdAt);
        card.innerHTML = `
          <div class="row">
            <div>
              <div><strong>${o.id}</strong></div>
              <div class="muted">${date.toLocaleString()}</div>
            </div>
            <div>
              <span class="tag">${o.status||'pending'}</span>
              <span class="tag">${o.deliveryStatus||'retrait'}</span>
              ${o.stockApplied ? '<span class="tag">stock appliqu√©</span>' : '<span class="tag">stock non appliqu√©</span>'}
            </div>
          </div>
          <div class="lines">
            ${(o.lines||[]).map(l=>`<div class="row"><span>${l.name} √ó ${l.qty}</span><strong>${fmt(view(l.lineHTG,o.currency),o.currency)}</strong></div>`).join('')}
            <hr style="border:none;border-top:1px dashed #e5e7eb;margin:8px 0">
            <div class="row"><span>Remise</span><strong>${o.discountHTG? '‚Äì '+fmt(view(o.discountHTG,o.currency),o.currency) : '‚Äî'}</strong></div>
            <div class="row"><span>Frais paiement</span><strong>${fmt(view(o.feeHTG,o.currency),o.currency)}</strong></div>
            <div class="row"><span>Livraison</span><strong>${fmt(view(o.deliveryHTG,o.currency),o.currency)}</strong></div>
            <div class="row"><span><strong>Total</strong></span><strong>${fmt(view(o.grandHTG,o.currency),o.currency)}</strong></div>
          </div>
          <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <label>Statut:
              <select data-id="${o.id}" data-k="status">
                ${['pending','paid','cancelled'].map(s=>`<option ${o.status===s?'selected':''}>${s}</option>`).join('')}
              </select>
            </label>
            <label>Livraison:
              <select data-id="${o.id}" data-k="deliveryStatus">
                ${['retrait','√† livrer','livr√©e'].map(s=>`<option ${o.deliveryStatus===s?'selected':''}>${s}</option>`).join('')}
              </select>
            </label>
            <label>Paiement v√©rifi√©:
              <select data-id="${o.id}" data-k="paymentVerified">
                ${['non','oui'].map(s=>`<option ${o.paymentVerified===s?'selected':''}>${s}</option>`).join('')}
              </select>
            </label>
            ${o.proof ? `<a class="btn" href="${o.proof.data}" download="${o.id}-preuve">${o.proof.type?.includes('pdf')?'T√©l√©charger PDF':'T√©l√©charger image'}</a>` : '<span class="muted">Aucune preuve</span>'}
            ${o.status === 'paid' ? 
              `<button class="btn alt" data-receipt="${o.id}">${o.paymentVerified==='oui' ? 'Re√ßu d√©finitif' : 'Re√ßu provisoire'}</button>` 
              : ''}
            <button class="btn alt" data-del="${o.id}">Supprimer</button>
          </div>
          ${o.proof && o.proof.type?.startsWith('image/') ? `<div style="margin-top:8px"><img class="thumb" src="${o.proof.data}" alt="preuve"></div>`:''}
        `;
        list.appendChild(card);
      });
    }
    if(applySales) applyNewSalesToStock();
  }

  /* ===== G√©n√©ration du re√ßu depuis l'admin ===== */
  function generateReceipt(id){
    const orders = JSON.parse(localStorage.getItem('kcn_orders')||'[]');
    const o = orders.find(x=>x.id===id);
    if(!o){ alert('Commande introuvable.'); return; }

    const method = o.payMethodLabel || o.payMethod || '‚Äî';
    const isVerified = o.paymentVerified === 'oui';

    const customer = o.customer || {};
    const nameVal  = customer.name  || '';
    const phoneVal = customer.phone || '';
    const emailVal = customer.email || '';
    const addrVal  = customer.addr  || '';
    const hasDelivery = (o.deliveryStatus && o.deliveryStatus !== 'retrait');

    const linesHTML = (o.lines||[]).map(l=>{
      const v = view(l.lineHTG, o.currency);
      return `<div style="display:flex;justify-content:space-between;padding:4px 0">
        <span>${l.name} √ó ${l.qty}</span>
        <strong>${fmt(v,o.currency)}</strong>
      </div>`;
    }).join('');

    const vDisc = view(o.discountHTG||0, o.currency);
    const vFee  = view(o.feeHTG||0, o.currency);
    const vDel  = view(o.deliveryHTG||0, o.currency);
    const vGrand= view(o.grandHTG||0, o.currency);
    const vNet  = view(o.netHTG||0, o.currency);

    const summaryHTML = `
      ${linesHTML}
      <hr style="border:none;border-top:1px dashed #e5e7eb;margin:8px 0">
      <div style="display:flex;justify-content:space-between">
        <span>Remise packs</span>
        <strong>${o.discountHTG ? '‚Äì '+fmt(vDisc,o.currency) : '‚Äî'}</strong>
      </div>
      <div style="display:flex;justify-content:space-between">
        <span>Total net</span>
        <strong>${fmt(vNet,o.currency)}</strong>
      </div>
      <div style="display:flex;justify-content:space-between">
        <span>Frais paiement</span>
        <strong>${fmt(vFee,o.currency)}</strong>
      </div>
      <div style="display:flex;justify-content:space-between">
        <span>Livraison locale</span>
        <strong>${fmt(vDel,o.currency)}</strong>
      </div>
      <div style="display:flex;justify-content:space-between;font-weight:800;margin-top:4px">
        <span>Total √† r√©gler</span>
        <strong>${fmt(vGrand,o.currency)}</strong>
      </div>
    `;

    const clientHTML = `
      <div class="meta" style="margin:8px 0 10px">
        <div><b>Client :</b> ${nameVal||'‚Äî'}</div>
        <div><b>Tel :</b> ${phoneVal||'‚Äî'}</div>
        <div><b>Email :</b> ${emailVal||'‚Äî'}</div>
        <div><b>Livraison :</b> ${hasDelivery ? 'Oui' : 'Non'}</div>
        ${hasDelivery ? `<div><b>Adresse :</b> ${addrVal||'‚Äî'}</div>` : ''}
      </div>`;

    const win = window.open('', '_blank');
    win.document.write(`
      <!doctype html><html lang="fr"><meta charset="utf-8">
      <title>Re√ßu ${o.id} ‚Äì KCN</title>
      <style>
        body{font-family:Montserrat,Arial,sans-serif;color:#0f172a}
        .sheet{max-width:700px;margin:20px auto;border:1px solid #e5e7eb;border-radius:12px;padding:18px;position:relative}
        h1{color:#0066cc;margin:0 0 8px 0}
        .meta{color:#475569}
        .paid-stamp{
          position:absolute;top:50%;left:50%;
          transform:translate(-50%,-50%) rotate(-25deg);
          font-size:72px;font-weight:bold;
          color:rgba(21,128,61,0.15);
          text-transform:uppercase;
          pointer-events:none;
          border:8px solid;padding:8px;
          white-space:nowrap
        }
      </style>
      <body>
        <div class="sheet">
          ${isVerified ? '<div class="paid-stamp">Pay√©</div>' : ''}
          <h1>KOLTIZ Club de Natation</h1>
          <div class="meta">${isVerified ? 'Re√ßu' : 'Re√ßu provisoire'} ‚Äì Commande ${o.id}</div>
          <div class="meta">Mode de paiement : <b>${method}</b></div>
          ${clientHTML}
          <hr>
          ${summaryHTML}
          <p class="meta" style="margin-top:10px">
            Paiement hors-ligne : Virement / MonCash / NatCash / Esp√®ces.<br>
            ${isVerified
              ? 'PAIEMENT V√âRIFI√â ET VALID√â PAR KCN.'
              : 'Un re√ßu d√©finitif sera √©mis apr√®s v√©rification du paiement.'}
          </p>
        </div>
        <script>window.print();<\/script>
      </body></html>
    `);
    win.document.close();
  }

  /* ===== D√©cr√©menter le stock depuis commandes non appliqu√©es ===== */
  function normalizeLineName(name){ return String(name||'').split(' ‚Äì Couleur')[0].trim(); }
  function getCatalog(){
    try{ return JSON.parse(localStorage.getItem('kcn_catalog')||'[]'); }catch{return []}
  }
  function setCatalog(c){ localStorage.setItem('kcn_catalog', JSON.stringify(c)); }
  function getStockMap(){
    try{ return JSON.parse(localStorage.getItem('kcn_stock')||'{}'); }catch{ return {}; }
  }
  function setStockMap(map){ localStorage.setItem('kcn_stock', JSON.stringify(map)); }

  function applyNewSalesToStock(){
    let orders = JSON.parse(localStorage.getItem('kcn_orders')||'[]');
    if(!orders.length) return;

    const catalog = getCatalog();
    if(!catalog.length){
      alert("Catalogue introuvable. Importez un catalogue dans l'onglet Stock.");
      return;
    }
    const byName = {}; catalog.forEach(it=>{ byName[it.name] = it; });

    const stock = getStockMap();
    let changed = false;

    orders.forEach(o=>{
      if(o.stockApplied) return;
      (o.lines||[]).forEach(l=>{
        const base = normalizeLineName(l.name);
        const item = byName[base];
        if(!item) return;
        const id = item.id;
        const cur = Number.isFinite(stock[id]) ? stock[id] : (Number.isFinite(item.stock)? item.stock : 0);
        const qty = Math.max(0, parseInt(l.qty||'0',10)||0);
        const next = Math.max(0, cur - qty);
        if(next !== cur){ stock[id] = next; changed = true; }
      });
      o.stockApplied = true;
      changed = true;
    });

    if(changed){
      setStockMap(stock);
      localStorage.setItem('kcn_orders', JSON.stringify(orders));
      if(document.querySelector('#panel-stock.panel.active')){ KCNStock.refresh(); }
      loadOrders(false);
      alert('Ventes appliqu√©es au stock ‚úì');
    }
  }

  /* ===================== PANEL STOCK ===================== */
  (function(){
    const TKEY = 'kcn_stock_thresholds';
    const SKEY = 'kcn_stock';
    const CKEY = 'kcn_catalog';

    const elBody  = document.getElementById('kcnStockBody');
    const elShow  = document.getElementById('kcnStockShowAll');
    const elSave  = document.getElementById('kcnStockSave');
    const elExport= document.getElementById('kcnStockExport');
    const elReset = document.getElementById('kcnStockReset');
    const elImpBtn= document.getElementById('kcnStockImportBtn');
    const elDlg   = document.getElementById('kcnStockImportDialog');
    const elImpTxt= document.getElementById('kcnStockImportText');
    const elImpCancel = document.getElementById('kcnStockImportCancel');
    const elImpApply  = document.getElementById('kcnStockImportApply');

    const thLow = document.getElementById('kcnThLow'); // Critique (‚â§ low)
    const thMid = document.getElementById('kcnThMid'); // Limit√© (‚â§ mid)

    function loadThresholds(){
      try{
        const t = JSON.parse(localStorage.getItem(TKEY) || '{}');
        if(Number.isFinite(t.low)) thLow.value = t.low;
        if(Number.isFinite(t.mid)) thMid.value = t.mid;
      }catch{}
    }
    function saveThresholds(){
      const low = Math.max(1, parseInt(thLow.value||'5',10)||5);
      const mid = Math.max(low+1, parseInt(thMid.value||'10',10)||10);
      localStorage.setItem(TKEY, JSON.stringify({low, mid}));
    }
    function getThresholds(){
      try{ return JSON.parse(localStorage.getItem(TKEY) || '{"low":5,"mid":10}'); }
      catch{ return {low:5, mid:10}; }
    }

    function getCatalogLocal(){
      try{
        const c = JSON.parse(localStorage.getItem(CKEY)||'[]');
        return Array.isArray(c)?c:[];
      }catch{return []}
    }
    function setCatalogLocal(catalog){ localStorage.setItem(CKEY, JSON.stringify(catalog)); }

    function getStockMapLocal(){
      try{ return JSON.parse(localStorage.getItem(SKEY)||'{}'); }catch{ return {}; }
    }
    function setStockMapLocal(map){ localStorage.setItem(SKEY, JSON.stringify(map)); }

    function statusTag(qty){
      const {low, mid} = getThresholds();
      if(qty<=0) return '<span class="kcn-tag red">Rupture</span>';
      if(qty<=low) return `<span class="kcn-tag orange">Critique</span>`;
      if(qty<=mid) return '<span class="kcn-tag orange">Limit√©</span>';
      return '<span class="kcn-tag green">En stock</span>';
    }

    function render(){
      const catalog = getCatalogLocal();
      if(!catalog.length){
        elBody.innerHTML = `<tr><td colspan="5" style="padding:12px" class="muted">
          Aucun catalogue d√©tect√©. Cliquez <b>Importer catalogue</b> et collez un JSON (id, name, stock).
        </td></tr>`;
        return;
      }
      const map = getStockMapLocal();
      elBody.innerHTML = catalog.map(item=>{
        const q = (map[item.id] ?? item.stock) | 0;
        return `<tr>
          <td style="padding:10px;border-bottom:1px solid #e5e7eb"><code>${item.id}</code></td>
          <td style="padding:10px;border-bottom:1px solid #e5e7eb">${item.name||''}</td>
          <td style="padding:10px;border-bottom:1px solid #e5e7eb;text-align:center">
            <input type="number" min="0" value="${q}" data-kcn-q="${item.id}" style="width:90px">
          </td>
          <td style="padding:10px;border-bottom:1px solid #e5e7eb;text-align:center" data-kcn-status="${item.id}">
            ${statusTag(q)}
          </td>
          <td style="padding:10px;border-bottom:1px solid #e5e7eb;text-align:center">
            <button class="btn alt" data-kcn-plus="${item.id}">+1</button>
            <button class="btn alt" data-kcn-minus="${item.id}">-1</button>
            <button class="btn alt" data-kcn-zero="${item.id}">0</button>
          </td>
        </tr>`;
      }).join('');
    }

    function attachEvents(){
      elBody.addEventListener('input', (e)=>{
        const id = e.target.getAttribute('data-kcn-q');
        if(!id) return;
        const v = qtySafe(e.target.value);
        const statusCell = elBody.querySelector(`[data-kcn-status="${id}"]`);
        if(statusCell) statusCell.innerHTML = statusTag(v);
      });
      elBody.addEventListener('click', (e)=>{
        const plus = e.target.getAttribute('data-kcn-plus');
        const minus= e.target.getAttribute('data-kcn-minus');
        const zero = e.target.getAttribute('data-kcn-zero');
        const id = plus || minus || zero;
        if(!id) return;
        const input = elBody.querySelector(`input[data-kcn-q="${id}"]`);
        if(!input) return;
        let v = qtySafe(input.value);
        if(plus){ v = v+1; }
        if(minus){ v = Math.max(0, v-1); }
        if(zero){ v = 0; }
        input.value = v;
        const statusCell = elBody.querySelector(`[data-kcn-status="${id}"]`);
        if(statusCell) statusCell.innerHTML = statusTag(v);
      });

      elSave.addEventListener('click', ()=>{
        const inputs = elBody.querySelectorAll('input[data-kcn-q]');
        const map = getStockMapLocal();
        inputs.forEach(i=>{
          const id = i.getAttribute('data-kcn-q');
          const v  = qtySafe(i.value);
          map[id] = v;
        });
        setStockMapLocal(map);
        saveThresholds();
        alert('Stock enregistr√© ‚úì');
      });

      elShow.addEventListener('click', ()=> render());

      elExport.addEventListener('click', ()=>{
        const data = { thresholds:getThresholds(), stock:getStockMapLocal(), catalog:getCatalogLocal() };
        const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'kcn_stock_export.json';
        a.click(); URL.revokeObjectURL(url);
      });

      elReset.addEventListener('click', ()=>{
        if(!confirm('R√©initialiser le stock local ?')) return;
        localStorage.removeItem(SKEY);
        render();
      });

      elImpBtn.addEventListener('click', ()=> elDlg.showModal());
      elImpCancel.addEventListener('click', ()=> elDlg.close());
      elImpApply.addEventListener('click', ()=>{
        try{
          const arr = JSON.parse(elImpTxt.value||'[]');
          if(!Array.isArray(arr)) throw new Error('Format invalide');
          setCatalogLocal(arr.map(x=>({id:String(x.id), name:String(x.name||''), stock:qtySafe(x.stock)})));
          elDlg.close(); elImpTxt.value = '';
          render();
        }catch(err){ alert('JSON invalide.'); }
      });

      thLow.addEventListener('change', saveThresholds);
      thMid.addEventListener('change', saveThresholds);
    }

    window.KCNStock = {
      open(){ loadThresholds(); render(); },
      refresh(){ render(); }
    };

    attachEvents();
  })();

  /* ===================== Porte d'acc√®s (APR√àS fonctions) ===================== */
  (function gate(){
    const ADMIN_FLAG = 'kcn_shop_admin_ok';
    const ADMIN_CODE = 'KCN@2025#Admin'; // code admin
    const gate = document.getElementById('gate');
    const mask = document.getElementById('mask');
    const input = document.getElementById('gateCode');
    const ok = document.getElementById('gateOk');
    const cancel = document.getElementById('gateCancel');
    const err = document.getElementById('gateErr');
    let tries = 0;

    function unlock(){
      sessionStorage.setItem(ADMIN_FLAG, '1');
      gate.style.display='none';
      mask.style.filter='none';
      mask.style.pointerEvents='auto';
      mask.style.userSelect='auto';
      input.value='';
      err.style.display='none';
      loadOrders(true);
    }
    function lock(){
      sessionStorage.removeItem(ADMIN_FLAG);
      gate.style.display='grid';
      mask.style.filter='blur(10px)';
      mask.style.pointerEvents='none';
      mask.style.userSelect='none';
      input.focus();
    }
    function submit(){
      const v = input.value.trim();
      if(v===ADMIN_CODE){ unlock(); return; }
      tries++;
      err.style.display='block';
      if(tries>=3){
        ok.disabled = true; input.disabled = true;
        err.textContent = 'Trop d‚Äôessais. Rechargez la page.';
      }
    }

    document.getElementById('btnLogout').addEventListener('click', lock);
    ok.addEventListener('click', submit);
    input.addEventListener('keydown', e=>{ if(e.key==='Enter') submit(); });
    cancel.addEventListener('click', ()=>{ input.value=''; err.style.display='none'; });

    // Raccourci pour rouvrir la porte
    window.addEventListener('keydown', (e)=>{
      if(e.shiftKey && e.altKey && String(e.key).toLowerCase()==='s'){ lock(); }
    });

    if(sessionStorage.getItem(ADMIN_FLAG)==='1'){ unlock(); }
    else{ lock(); }
  })();
</script>
</body>
</html>
